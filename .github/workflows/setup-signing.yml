name: 配置Android签名

on:
  workflow_dispatch:
    inputs:
      setup_secrets:
        description: '设置GitHub Secrets'
        required: true
        default: 'false'
        type: boolean

jobs:
  setup-signing:
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.setup_secrets == 'true' }}
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4

    - name: 显示签名配置说明
      run: |
        echo "=== Android签名配置指南 ==="
        echo ""
        echo "为了构建Release APK，需要配置以下GitHub Secrets:"
        echo ""
        echo "1. 进入GitHub仓库 -> Settings -> Secrets and variables -> Actions"
        echo "2. 点击 'New repository secret'"
        echo "3. 添加以下secrets:"
        echo ""
        echo "KEYSTORE_FILE: 密钥库文件内容（base64编码）"
        echo "  - 将.keystore文件转换为base64: base64 -i release.keystore"
        echo "  - 复制输出内容作为secret值"
        echo ""
        echo "KEYSTORE_PASSWORD: 密钥库密码"
        echo "KEY_ALIAS: 密钥别名"
        echo "KEY_PASSWORD: 密钥密码"
        echo ""
        echo "4. 保存所有secrets"
        echo ""
        echo "注意: 这些secrets是加密存储的，只有GitHub Actions可以访问"

    - name: 创建签名配置文件
      run: |
        mkdir -p android/app
        
        cat > android/app/signing.gradle << 'EOF'
        def keystoreProperties = new Properties()
        def keystorePropertiesFile = rootProject.file('key.properties')
        if (keystorePropertiesFile.exists()) {
            keystoreProperties.load(new FileInputStream(keystorePropertiesFile))
        }

        android {
            signingConfigs {
                release {
                    if (keystoreProperties['keyAlias']) {
                        keyAlias keystoreProperties['keyAlias']
                        keyPassword keystoreProperties['keyPassword']
                        storeFile keystoreProperties['storeFile'] ? file(keystoreProperties['storeFile']) : null
                        storePassword keystoreProperties['storePassword']
                    }
                }
            }
            buildTypes {
                release {
                    signingConfig signingConfigs.release
                    minifyEnabled true
                    shrinkResources true
                    proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'
                }
            }
        }
        EOF

        echo "已创建签名配置文件: android/app/signing.gradle"

    - name: 创建ProGuard配置
      run: |
        mkdir -p android/app
        
        cat > android/app/proguard-rules.pro << 'EOF'
        # Flutter特定规则
        -keep class io.flutter.app.** { *; }
        -keep class io.flutter.plugin.**  { *; }
        -keep class io.flutter.util.**  { *; }
        -keep class io.flutter.view.**  { *; }
        -keep class io.flutter.**  { *; }
        -keep class io.flutter.plugins.**  { *; }
        
        # WebView相关规则
        -keepclassmembers class * extends android.webkit.WebViewClient {
            public void *(android.view.View, android.graphics.WebView, java.lang.String, android.graphics.Bitmap);
            public boolean *(android.webkit.WebView, java.lang.String, android.graphics.WebViewClient);
        }
        
        # 网络请求规则
        -keep class okhttp3.** { *; }
        -keep interface okhttp3.** { *; }
        -dontwarn okhttp3.**
        
        # JSON序列化规则
        -keep class * implements java.io.Serializable { *; }
        -keepclassmembers class * implements java.io.Serializable {
            static final long serialVersionUID;
            private static final java.io.ObjectStreamField[] serialPersistentFields;
            !static !transient <fields>;
            private void writeObject(java.io.ObjectOutputStream);
            private void readObject(java.io.ObjectInputStream);
            java.lang.Object writeReplace();
            java.lang.Object readResolve();
        }
        
        # 数据库相关规则
        -keep class * extends android.database.sqlite.SQLiteOpenHelper { *; }
        
        # 通用规则
        -keepattributes *Annotation*
        -keepattributes Signature
        -keepattributes InnerClasses
        -keepattributes EnclosingMethod
        
        # 移除日志
        -assumenosideeffects class android.util.Log {
            public static *** d(...);
            public static *** v(...);
            public static *** i(...);
        }
        EOF

        echo "已创建ProGuard配置文件: android/app/proguard-rules.pro"

    - name: 创建密钥属性模板
      run: |
        mkdir -p android
        
        cat > android/key.properties.template << 'EOF'
        # 密钥库文件路径（相对于android目录）
        storeFile=../release.keystore
        # 密钥库密码
        storePassword=your_keystore_password
        # 密钥别名
        keyAlias=your_key_alias
        # 密钥密码
        keyPassword=your_key_password
        EOF

        echo "已创建密钥属性模板: android/key.properties.template"

    - name: 创建签名设置说明
      run: |
        cat > SIGNING_SETUP.md << 'EOF'
        # Android签名配置指南

        ## 概述
        为了构建Release APK，需要配置Android应用签名。本指南将帮助您完成签名配置。

        ## 步骤1: 生成密钥库
        ```bash
        # 生成密钥库文件
        keytool -genkey -v -keystore release.keystore -alias release -keyalg RSA -keysize 2048 -validity 10000
        ```
        记住您输入的密码和信息，这些将用作签名配置。

        ## 步骤2: 配置GitHub Secrets
        1. 进入GitHub仓库 -> Settings -> Secrets and variables -> Actions
        2. 点击 'New repository secret'
        3. 添加以下secrets:

        ### KEYSTORE_FILE
        - 将密钥库文件转换为base64:
        ```bash
        base64 -i release.keystore
        ```
        - 复制输出内容作为KEYSTORE_FILE的值

        ### KEYSTORE_PASSWORD
        - 输入生成密钥库时设置的密码

        ### KEY_ALIAS
        - 输入密钥别名（通常是 'release'）

        ### KEY_PASSWORD
        - 输入密钥密码（通常与密钥库密码相同）

        ## 步骤3: 修改构建配置
        在 `android/app/build.gradle` 中添加:
        ```gradle
        apply from: '../app/signing.gradle'
        ```

        ## 步骤4: 测试构建
        配置完成后，触发Release构建测试:
        - 进入Actions页面
        - 选择"构建APK"工作流
        - 选择构建类型为"release"
        - 运行构建

        ## 安全注意事项
        - 永远不要将密钥库文件提交到仓库
        - 密钥信息只存储在GitHub Secrets中
        - 定期备份密钥库文件到安全位置
        - 如果密钥库丢失，将无法更新已发布的应用

        ## 故障排除
        如果构建失败，请检查:
        1. GitHub Secrets是否正确配置
        2. 密钥库文件是否损坏
        3. 密码是否正确
        4. 密钥别名是否正确
        EOF

        echo "已创建签名设置说明: SIGNING_SETUP.md"

    - name: 提交配置文件
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        git add android/app/signing.gradle android/app/proguard-rules.pro android/key.properties.template SIGNING_SETUP.md
        git commit -m "feat: 添加Android签名配置和ProGuard规则"
        git push origin HEAD