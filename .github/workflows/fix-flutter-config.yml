name: Flutter Project Configuration Fix

on:
  workflow_dispatch:
    inputs:
      debug:
        description: 'Debug build instead of release'
        required: false
        default: 'false'
        type: boolean
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  fix-flutter-config:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.35.8'
        channel: 'stable'
        
    - name: Cache Flutter packages
      uses: actions/cache@v3
      with:
        path: |
          ~/.pub-cache
          ~/.flutter-devtools
          ${{ runner.tool_cache }}/flutter
        key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.lock') }}
        
    - name: Get Flutter info
      run: |
        flutter --version
        flutter doctor
        flutter config --no-analytics
        
    - name: Fix Flutter project configuration
      run: |
        echo "ðŸ”§ å¼€å§‹ä¿®å¤Flutteré¡¹ç›®é…ç½®..."
        
        # æ£€æŸ¥æ˜¯å¦åœ¨Flutteré¡¹ç›®æ ¹ç›®å½•
        if [ ! -f "pubspec.yaml" ]; then
          echo "âŒ é”™è¯¯: ä¸åœ¨Flutteré¡¹ç›®æ ¹ç›®å½•"
          exit 1
        fi
        
        echo "âœ… æ‰¾åˆ°Flutteré¡¹ç›®"
        
        # ä¿®å¤ settings.gradle
        echo "ðŸ”§ æ›´æ–° settings.gradle..."
        cat > android/settings.gradle << 'EOF'
pluginManagement {
    def flutterSdkPath = {
        def properties = new Properties()
        file("local.properties").withInputStream { properties.load(it) }
        return properties.getProperty("flutter.sdk")
    }()
    
    repositories {
        google()
        mavenCentral()
        gradlePluginPortal()
    }
}

plugins {
    id "dev.flutter.flutter-gradle-plugin" apply false
}

include ":app"
EOF

        # ä¿®å¤ app/build.gradle
        echo "ðŸ”§ æ›´æ–° app/build.gradle..."
        cat > android/app/build.gradle << 'EOF'
def localProperties = new Properties()
def localPropertiesFile = rootProject.file('local.properties')
if (localPropertiesFile.exists()) {
    localPropertiesFile.withReader('UTF-8') { reader ->
        localProperties.load(reader)
    }
}

def flutterRoot = localProperties.getProperty('flutter.sdk')
if (flutterRoot == null) {
    throw new GradleException("Flutter SDK not found. Define location with flutter.sdk in the local.properties file.")
}

def flutterVersionCode = localProperties.getProperty('flutter.versionCode')
if (flutterVersionCode == null) {
    flutterVersionCode = '1'
}

def flutterVersionName = localProperties.getProperty('flutter.versionName')
if (flutterVersionName == null) {
    flutterVersionName = '1.0'
}

android {
    namespace 'com.recipe.app'
    compileSdkVersion 34
    ndkVersion "25.1.8937393"

    compileOptions {
        sourceCompatibility JavaVersion.VERSION_1_8
        targetCompatibility JavaVersion.VERSION_1_8
    }

    kotlinOptions {
        jvmTarget = '1.8'
    }

    sourceSets {
        main.java.srcDirs += 'src/main/kotlin'
    }

    defaultConfig {
        applicationId "com.recipe.app"
        minSdkVersion 21
        targetSdkVersion 34
        versionCode flutterVersionCode.toInteger()
        versionName flutterVersionName
    }

    buildTypes {
        release {
            signingConfig signingConfigs.debug
        }
    }
}

flutter {
    source '../..'
}

dependencies {
    implementation "org.jetbrains.kotlin:kotlin-stdlib-jdk7:$kotlin_version"
}
EOF

        # ä¿®å¤ gradle.properties
        echo "ðŸ”§ æ›´æ–° gradle.properties..."
        cat > android/gradle.properties << 'EOF'
# Flutter gradle.properties é…ç½®æ–‡ä»¶ - æ ‡å‡†ç‰ˆ

# AndroidXæ”¯æŒ
android.useAndroidX=true
android.enableJetifier=true

# Gradle JVMå‚æ•° - å¢žåŠ å†…å­˜ä»¥è§£å†³æž„å»ºé—®é¢˜
org.gradle.jvmargs=-Xmx4G -XX:+HeapDumpOnOutOfMemoryError

# æž„å»ºä¼˜åŒ–
org.gradle.parallel=true
org.gradle.caching=true

# Kotliné…ç½®
kotlin.code.style=official

# Androidæž„å»ºä¼˜åŒ–
android.enableR8=true
android.defaults.buildfeatures.buildconfig=true
android.defaults.buildfeatures.aidl=false
android.defaults.buildfeatures.renderscript=false
android.defaults.buildfeatures.resvalues=false
android.defaults.buildfeatures.shaders=false
android.defaults.buildfeatures.viewBinding=false

# å¢žé‡ç¼–è¯‘
org.gradle.unsafe.configuration-cache=true
org.gradle.unsafe.configuration-cache-problems=warn

# Androidç¼–è¯‘é€‰é¡¹
android.compileOptions.sourceCompatibility=JavaVersion.VERSION_1_8
android.compileOptions.targetCompatibility=JavaVersion.VERSION_1_8
EOF

        # å‡çº§ Gradle wrapper
        echo "ðŸ”§ å‡çº§ Gradle wrapper..."
        if [ -f "android/gradle/wrapper/gradle-wrapper.properties" ]; then
            sed -i 's|gradle-8\.[0-9]\+-|gradle-8.4-|g' android/gradle/wrapper/gradle-wrapper.properties
            echo "âœ… Gradle wrapper å‡çº§å®Œæˆ"
        else
            echo "âš ï¸ Gradle wrapper æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡å‡çº§"
        fi

        echo "âœ… Flutteré¡¹ç›®é…ç½®ä¿®å¤å®Œæˆ"
        
    - name: Setup Git
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
    - name: Check changes
      id: changes
      run: |
        git status
        if git diff --quiet; then
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "ðŸ” æ²¡æœ‰æ£€æµ‹åˆ°é…ç½®å˜æ›´"
        else
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "âœ… æ£€æµ‹åˆ°é…ç½®å˜æ›´"
        fi
        
    - name: Commit and push changes
      if: steps.changes.outputs.changed == 'true'
      run: |
        echo "ðŸ“ æäº¤é…ç½®æ›´æ–°..."
        git add android/settings.gradle
        git add android/app/build.gradle
        git add android/gradle.properties
        git add android/gradle/wrapper/gradle-wrapper.properties
        
        git commit -m "chore(android): ä¿®å¤Flutteré¡¹ç›®é…ç½®

- æ›´æ–°åˆ°çŽ°ä»£Gradleæ’ä»¶é…ç½®
- å¯ç”¨AndroidXæ”¯æŒ
- å¢žåŠ JVMå†…å­˜é™åˆ¶
- å¯ç”¨æž„å»ºæ€§èƒ½ä¼˜åŒ–
- å‡çº§åˆ°Gradle 8.4

ä¿®å¤ 'unsupported Gradle project' é”™è¯¯"
        
        echo "ðŸš€ æŽ¨é€åˆ°è¿œç¨‹ä»“åº“..."
        git push origin HEAD:${{ github.ref_name }}
        
    - name: Clean and get dependencies
      run: |
        echo "ðŸ§¹ æ¸…ç†é¡¹ç›®ç¼“å­˜..."
        flutter clean
        
        echo "ðŸ“¦ èŽ·å–ä¾èµ–åŒ…..."
        flutter pub get
        
        echo "ðŸ” æ£€æŸ¥ä¾èµ–å…³ç³»..."
        flutter pub deps
        
    - name: Analyze Flutter project
      run: |
        echo "ðŸ” åˆ†æžFlutteré¡¹ç›®..."
        flutter analyze --no-fatal-infos
        
    - name: Build Android APK
      run: |
        echo "ðŸ—ï¸ å¼€å§‹æž„å»ºAndroid APK..."
        
        # æ ¹æ®è¾“å…¥å†³å®šæž„å»ºç±»åž‹
        if [ "${{ github.event.inputs.debug }}" = "true" ] || [ "${{ github.event_name }}" = "pull_request" ]; then
          echo "ðŸ”§ æž„å»ºDebug APK..."
          flutter build apk --debug
          apk_path="build/outputs/apk/debug/app-debug.apk"
        else
          echo "ðŸš€ æž„å»ºRelease APK..."
          flutter build apk --release
          apk_path="build/outputs/apk/release/app-release.apk"
        fi
        
        if [ -f "$apk_path" ]; then
          echo "âœ… APKæž„å»ºæˆåŠŸ: $apk_path"
          ls -la $apk_path
        else
          echo "âŒ APKæž„å»ºå¤±è´¥"
          exit 1
        fi
        
    - name: Upload APK artifact
      uses: actions/upload-artifact@v3
      with:
        name: recipe-app-apk
        path: build/outputs/apk/**/*.apk
        retention-days: 30
        
    - name: Create status summary
      run: |
        echo "## ðŸŽ‰ Flutteré¡¹ç›®é…ç½®ä¿®å¤å®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… ä¿®å¤å†…å®¹" >> $GITHUB_STEP_SUMMARY
        echo "- æ›´æ–°äº†Android Gradleé…ç½®æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        echo "- å¯ç”¨äº†AndroidXæ”¯æŒ" >> $GITHUB_STEP_SUMMARY
        echo "- å‡çº§åˆ°Gradle 8.4" >> $GITHUB_STEP_SUMMARY
        echo "- ä¼˜åŒ–äº†æž„å»ºæ€§èƒ½é…ç½®" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“± åº”ç”¨ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "- **åº”ç”¨åç§°**: èœè°±å¤§å…¨" >> $GITHUB_STEP_SUMMARY
        echo "- **åŒ…å**: com.recipe.app" >> $GITHUB_STEP_SUMMARY
        echo "- **æœ€ä½ŽAndroidç‰ˆæœ¬**: API 21" >> $GITHUB_STEP_SUMMARY
        echo "- **åŒ…å«èœè°±**: 10ä¸ªç»å…¸ä¸­å¼èœè°±" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”— ç›¸å…³æ–‡æ¡£" >> $GITHUB_STEP_SUMMARY
        echo "- [Flutteré…ç½®ä¿®å¤æŒ‡å—](flutter_quick_fix_guide.md)" >> $GITHUB_STEP_SUMMARY
        echo "- [è¯¦ç»†æŠ€æœ¯æŠ¥å‘Š](flutter_gradle_project_fix_complete.md)" >> $GITHUB_STEP_SUMMARY
        echo "- [å®Œæ•´äº¤ä»˜æŠ¥å‘Š](flutter_recipe_app_final_delivery_complete.md)" >> $GITHUB_STEP_SUMMARY