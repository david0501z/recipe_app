name: Flutter Project Configuration Fix & Build

on:
  workflow_dispatch:
    inputs:
      debug:
        description: 'æ„å»ºDebug APK (é»˜è®¤Release)'
        required: false
        default: 'false'
        type: boolean
      force_rebuild:
        description: 'å¼ºåˆ¶é‡å»ºé¡¹ç›®ç»“æ„'
        required: false
        default: 'false'
        type: boolean
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  fix-flutter-config:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        clean: false
        
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.35.8'
        channel: 'stable'
        
    - name: Cache Flutter packages
      uses: actions/cache@v3
      with:
        path: |
          ~/.pub-cache
          ~/.flutter-devtools
          ${{ runner.tool_cache }}/flutter
        key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.lock') }}
        restore-keys: |
          ${{ runner.os }}-flutter-
          
    - name: Get Flutter info
      run: |
        flutter --version
        flutter doctor --android-licenses
        flutter config --no-analytics
        echo "ğŸ“ å·¥ä½œç›®å½•: $(pwd)"
        ls -la
        
    - name: Analyze current project structure
      run: |
        echo "ğŸ” åˆ†æå½“å‰é¡¹ç›®ç»“æ„..."
        if [ -f "pubspec.yaml" ]; then
          echo "âœ… æ‰¾åˆ°Flutteré¡¹ç›®"
          grep "^name:" pubspec.yaml
        else
          echo "âŒ æœªæ‰¾åˆ°pubspec.yamlï¼Œä¸æ˜¯æœ‰æ•ˆçš„Flutteré¡¹ç›®"
          exit 1
        fi
        
        if [ -d "android" ]; then
          echo "âœ… æ‰¾åˆ°Androidé…ç½®"
          ls android/
        else
          echo "âŒ æœªæ‰¾åˆ°Androidé…ç½®"
          exit 1
        fi

    - name: Create project backup
      run: |
        echo "ğŸ’¾ åˆ›å»ºé¡¹ç›®å¤‡ä»½..."
        if [ ! -d "project_backup" ]; then
          mkdir -p project_backup
        fi
        
        # å¤‡ä»½é‡è¦æ–‡ä»¶
        cp -r lib project_backup/ 2>/dev/null || true
        cp -r assets project_backup/ 2>/dev/null || true
        cp pubspec.yaml project_backup/ 2>/dev/null || true
        cp -r .github project_backup/ 2>/dev/null || true
        
        echo "âœ… å¤‡ä»½å®Œæˆ"
        ls -la project_backup/

    - name: Flutter project reconstruction
      if: github.event.inputs.force_rebuild == 'true' || ! -f "android/settings.gradle" || ! -f "android/app/build.gradle"
      run: |
        echo "ğŸ”¨ å¼€å§‹é‡å»ºFlutteré¡¹ç›®..."
        
        # è·å–é¡¹ç›®åç§°
        PROJECT_NAME=$(grep "^name:" pubspec.yaml | awk '{print $2}')
        echo "ğŸ“¦ é¡¹ç›®åç§°: $PROJECT_NAME"
        
        # åˆ›å»ºä¸´æ—¶ç›®å½•
        TEMP_DIR="temp_rebuild_$(date +%Y%m%d_%H%M%S)"
        mkdir -p "$TEMP_DIR"
        
        # åˆ›å»ºæ–°çš„Flutteré¡¹ç›®
        echo "ğŸ—ï¸ åˆ›å»ºå…¨æ–°é¡¹ç›®..."
        flutter create -t app "$TEMP_DIR/$PROJECT_NAME"
        
        # å¤åˆ¶é‡è¦æ–‡ä»¶
        echo "ğŸ“ å¤åˆ¶é¡¹ç›®æ–‡ä»¶..."
        
        # å¤åˆ¶Dartä»£ç 
        if [ -d "lib" ]; then
          rm -rf "$TEMP_DIR/$PROJECT_NAME/lib"
          cp -r lib "$TEMP_DIR/$PROJECT_NAME/"
          echo "âœ… å¤åˆ¶lib/ç›®å½•"
        fi
        
        # å¤åˆ¶assets
        if [ -d "assets" ]; then
          rm -rf "$TEMP_DIR/$PROJECT_NAME/assets"
          cp -r assets "$TEMP_DIR/$PROJECT_NAME/"
          echo "âœ… å¤åˆ¶assets/ç›®å½•"
        fi
        
        # å¤åˆ¶pubspec.yaml
        if [ -f "pubspec.yaml" ]; then
          cp pubspec.yaml "$TEMP_DIR/$PROJECT_NAME/"
          echo "âœ… å¤åˆ¶pubspec.yaml"
        fi
        
        # å¤åˆ¶.github
        if [ -d ".github" ]; then
          rm -rf "$TEMP_DIR/$PROJECT_NAME/.github"
          cp -r .github "$TEMP_DIR/$PROJECT_NAME/"
          echo "âœ… å¤åˆ¶.github/ç›®å½•"
        fi
        
        # å¤åˆ¶å…¶ä»–æ–‡æ¡£
        for file in README.md *.md; do
          if [ -f "$file" ] && [ "$file" != "pubspec.yaml" ]; then
            cp "$file" "$TEMP_DIR/$PROJECT_NAME/" 2>/dev/null || true
          fi
        done
        
        # ç§»åŠ¨æ–°é¡¹ç›®æ–‡ä»¶
        echo "ğŸ”„ æ›¿æ¢é¡¹ç›®æ–‡ä»¶..."
        rm -rf lib assets pubspec.yaml .github *.md
        
        cp -r "$TEMP_DIR/$PROJECT_NAME"/* .
        cp -r "$TEMP_DIR/$PROJECT_NAME"/.[^.]* . 2>/dev/null || true
        
        # æ¸…ç†
        rm -rf "$TEMP_DIR"
        
        echo "âœ… é¡¹ç›®é‡å»ºå®Œæˆ"

    - name: Modern Flutter Android Configuration
      run: |
        echo "âš™ï¸ åº”ç”¨ç°ä»£Flutter Androidé…ç½®..."
        
        # 1. æ›´æ–° settings.gradle (æœ€æ–°æ ‡å‡†æ ¼å¼)
        echo "ğŸ”§ æ›´æ–° settings.gradle..."
        cat > android/settings.gradle << 'EOF'
pluginManagement {
    def flutterSdkPath = {
        def properties = new Properties()
        file("local.properties").withInputStream { properties.load(it) }
        return properties.getProperty("flutter.sdk")
    }()
    
    repositories {
        google()
        mavenCentral()
        gradlePluginPortal()
    }
}

plugins {
    id "dev.flutter.flutter-gradle-plugin" apply false
}

include ":app"
EOF

        # 2. æ›´æ–° app/build.gradle (ä½¿ç”¨plugins block)
        echo "ğŸ”§ æ›´æ–° app/build.gradle..."
        cat > android/app/build.gradle << 'EOF'
plugins {
    id "com.android.application"
    id "kotlin-android"
    id "dev.flutter.flutter-gradle-plugin"
}

def localProperties = new Properties()
def localPropertiesFile = rootProject.file('local.properties')
if (localPropertiesFile.exists()) {
    localPropertiesFile.withReader('UTF-8') { reader ->
        localProperties.load(reader)
    }
}

def flutterRoot = localProperties.getProperty('flutter.sdk')
if (flutterRoot == null) {
    throw new GradleException("Flutter SDK not found. Define location with flutter.sdk in the local.properties file.")
}

def flutterVersionCode = localProperties.getProperty('flutter.versionCode')
if (flutterVersionCode == null) {
    flutterVersionCode = '1'
}

def flutterVersionName = localProperties.getProperty('flutter.versionName')
if (flutterVersionName == null) {
    flutterVersionName = '1.0'
}

android {
    namespace 'com.example.recipe_app'
    compileSdk 34
    ndkVersion "25.1.8937393"

    compileOptions {
        sourceCompatibility JavaVersion.VERSION_1_8
        targetCompatibility JavaVersion.VERSION_1_8
    }

    kotlinOptions {
        jvmTarget = '1.8'
    }

    sourceSets {
        main.java.srcDirs += 'src/main/kotlin'
    }

    defaultConfig {
        applicationId "com.example.recipe_app"
        minSdk 21
        targetSdk 34
        versionCode flutterVersionCode.toInteger()
        versionName flutterVersionName
        multiDexEnabled true
    }

    buildTypes {
        release {
            signingConfig signingConfigs.debug
        }
    }
}

flutter {
    source '../..'
}

dependencies {
    implementation "org.jetbrains.kotlin:kotlin-stdlib-jdk7:1.9.22"
}
EOF

        # 3. æ›´æ–° gradle.properties
        echo "ğŸ”§ æ›´æ–° gradle.properties..."
        cat > android/gradle.properties << 'EOF'
# Flutter Android é…ç½® - ç°ä»£åŒ–æ ‡å‡†ç‰ˆ

# AndroidXæ”¯æŒ
android.useAndroidX=true
android.enableJetifier=true

# Gradleæ€§èƒ½ä¼˜åŒ–
org.gradle.jvmargs=-Xmx4G -XX:+HeapDumpOnOutOfMemoryError
org.gradle.parallel=true
org.gradle.caching=true
org.gradle.configureondemand=true

# Kotliné…ç½®
kotlin.code.style=official
kotlin.incremental=true

# Androidæ„å»ºä¼˜åŒ–
android.enableR8=true
android.defaults.buildfeatures.buildconfig=true
android.defaults.buildfeatures.aidl=false
android.defaults.buildfeatures.renderscript=false
android.defaults.buildfeatures.resvalues=false
android.defaults.buildfeatures.shaders=false
android.defaults.buildfeatures.viewBinding=false

# å¢é‡ç¼–è¯‘å’Œç¼“å­˜
org.gradle.unsafe.configuration-cache=true
org.gradle.unsafe.configuration-cache-problems=warn

# Androidç¼–è¯‘é€‰é¡¹
android.compileOptions.sourceCompatibility=JavaVersion.VERSION_1_8
android.compileOptions.targetCompatibility=JavaVersion.VERSION_1_8

# å†…å­˜ä¼˜åŒ–
android.dexOptions.incremental=true
android.dexOptions.javaMaxHeapSize=4g

# æ„å»ºç¼“å­˜
android.enableBuildCache=true
EOF

        # 4. æ›´æ–° Gradle wrapper
        echo "ğŸ”§ å‡çº§ Gradle wrapper..."
        if [ -f "android/gradle/wrapper/gradle-wrapper.properties" ]; then
            sed -i 's|gradle-[0-9]\.[0-9]\+\(-.*\)\?|gradle-8.4|g' android/gradle/wrapper/gradle-wrapper.properties
            echo "âœ… Gradle wrapper å‡çº§åˆ° 8.4"
        else
            echo "âš ï¸ Gradle wrapper æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°æ–‡ä»¶..."
            mkdir -p android/gradle/wrapper
            cat > android/gradle/wrapper/gradle-wrapper.properties << 'EOF'
distributionBase=GRADLE_USER_HOME
distributionPath=wrapper/dists
distributionUrl=https\://services.gradle.org/distributions/gradle-8.4-all.zip
networkTimeout=10000
validateDistributionUrl=true
zipStoreBase=GRADLE_USER_HOME
zipStorePath=wrapper/dists
EOF
        fi

        echo "âœ… ç°ä»£Flutter Androidé…ç½®åº”ç”¨å®Œæˆ"

    - name: Fix project package name
      run: |
        echo "ğŸ”§ æ£€æŸ¥å¹¶ä¿®å¤åŒ…å..."
        
        # è·å–åŒ…å
        PACKAGE_NAME="com.example.recipe_app"
        
        # æ›´æ–° AndroidManifest.xml
        if [ -f "android/app/src/main/AndroidManifest.xml" ]; then
            sed -i "s/package=\"[^\"]*\"/package=\"$PACKAGE_NAME\"/" android/app/src/main/AndroidManifest.xml
            echo "âœ… æ›´æ–°AndroidManifest.xmlåŒ…å"
        fi
        
        # éªŒè¯é…ç½®
        grep -n "namespace\|applicationId" android/app/build.gradle || echo "âš ï¸ æœªæ‰¾åˆ°ç›¸å…³é…ç½®"

    - name: Setup Git for commits
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        echo "âœ… Gité…ç½®å®Œæˆ"

    - name: Check and commit configuration changes
      id: changes
      run: |
        echo "ğŸ” æ£€æŸ¥é…ç½®å˜æ›´..."
        git status
        
        if git diff --quiet; then
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "ğŸ” æ²¡æœ‰æ£€æµ‹åˆ°é…ç½®å˜æ›´"
        else
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "âœ… æ£€æµ‹åˆ°é…ç½®å˜æ›´"
          git diff --stat
        fi

    - name: Commit configuration fixes
      if: steps.changes.outputs.changed == 'true'
      run: |
        echo "ğŸ“ æäº¤é…ç½®æ›´æ–°..."
        
        git add android/
        git add .
        
        git commit -m "feat(android): åº”ç”¨ç°ä»£Flutteré…ç½®å’Œé‡å»º

- ä½¿ç”¨æœ€æ–°çš„Flutter Gradleæ’ä»¶ç³»ç»Ÿ
- å®Œå…¨é‡å»ºAndroidé¡¹ç›®ç»“æ„
- å¯ç”¨AndroidXå’ŒJetifieræ”¯æŒ
- å‡çº§åˆ°Gradle 8.4
- ä¼˜åŒ–æ„å»ºæ€§èƒ½å’Œå†…å­˜é…ç½®
- ä¿®å¤'unsupported Gradle project'é”™è¯¯

è¿™ä¸ªæ›´æ–°é‡‡ç”¨Flutterå®˜æ–¹æ¨èçš„æ ‡å‡†é…ç½®ï¼Œ
ç¡®ä¿é¡¹ç›®å¯ä»¥æ­£å¸¸æ„å»ºå’Œè¿è¡Œã€‚"
        
        echo "ğŸš€ æ¨é€åˆ°è¿œç¨‹ä»“åº“..."
        git push origin HEAD:${{ github.ref_name }}

    - name: Clean and update dependencies
      run: |
        echo "ğŸ§¹ æ¸…ç†å’Œæ›´æ–°ä¾èµ–..."
        flutter clean
        flutter pub get
        echo "âœ… ä¾èµ–æ›´æ–°å®Œæˆ"

    - name: Analyze Flutter project
      run: |
        echo "ğŸ” åˆ†æFlutteré¡¹ç›®..."
        flutter analyze --no-fatal-infos
        echo "âœ… é¡¹ç›®åˆ†æå®Œæˆ"

    - name: Build Android APK
      run: |
        echo "ğŸ—ï¸ å¼€å§‹æ„å»ºAndroid APK..."
        
        # æ ¹æ®è¾“å…¥å†³å®šæ„å»ºç±»å‹
        if [ "${{ github.event.inputs.debug }}" = "true" ] || [ "${{ github.event_name }}" = "pull_request" ]; then
          echo "ğŸ”§ æ„å»ºDebug APK..."
          flutter build apk --debug --verbose
          APK_PATH="build/outputs/apk/debug/app-debug.apk"
        else
          echo "ğŸš€ æ„å»ºRelease APK..."
          flutter build apk --release --verbose
          APK_PATH="build/outputs/apk/release/app-release.apk"
        fi
        
        echo "ğŸ“± APKè·¯å¾„: $APK_PATH"
        
        if [ -f "$APK_PATH" ]; then
          echo "âœ… APKæ„å»ºæˆåŠŸ!"
          ls -la "$APK_PATH"
          file "$APK_PATH"
        else
          echo "âŒ APKæ„å»ºå¤±è´¥"
          ls -la build/outputs/apk/
          exit 1
        fi

    - name: Build Android App Bundle
      run: |
        echo "ğŸ“¦ æ„å»ºAndroid App Bundle..."
        
        if [ "${{ github.event.inputs.debug }}" = "true" ] || [ "${{ github.event_name }}" = "pull_request" ]; then
          echo "ğŸ”§ æ„å»ºDebug AAB..."
          flutter build appbundle --debug --verbose || echo "âš ï¸ Debug AABæ„å»ºå¤±è´¥ï¼Œä½†APKæ„å»ºæˆåŠŸ"
        else
          echo "ğŸš€ æ„å»ºRelease AAB..."
          flutter build appbundle --release --verbose
        fi

    - name: Upload APK artifact
      uses: actions/upload-artifact@v3
      with:
        name: recipe-app-apk-${{ github.run_number }}
        path: |
          build/outputs/apk/**/*.apk
          build/outputs/bundle/**/*.aab
        retention-days: 30
        if-no-files-found: warn

    - name: Test APK installation
      if: contains(github.event.inputs.debug, 'true') || contains(github.event_name, 'pull_request')
      run: |
        echo "ğŸ§ª æµ‹è¯•APK (æ¨¡æ‹Ÿå®‰è£…æ£€æŸ¥)..."
        
        APK_FILE=$(find build/outputs/apk -name "*.apk" -type f | head -1)
        if [ -n "$APK_FILE" ]; then
          echo "ğŸ“± æ‰¾åˆ°APKæ–‡ä»¶: $APK_FILE"
          echo "ğŸ“ æ–‡ä»¶å¤§å°: $(du -h "$APK_FILE" | cut -f1)"
          
          # ç®€å•çš„APKéªŒè¯
          file "$APK_FILE"
          unzip -l "$APK_FILE" | head -5
        else
          echo "âš ï¸ æœªæ‰¾åˆ°APKæ–‡ä»¶è¿›è¡Œæµ‹è¯•"
        fi

    - name: Create detailed summary
      run: |
        BUILD_TYPE="Release"
        if [ "${{ github.event.inputs.debug }}" = "true" ] || [ "${{ github.event_name }}" = "pull_request" ]; then
          BUILD_TYPE="Debug"
        fi
        
        echo "## ğŸ‰ Flutteré¡¹ç›®ç°ä»£åŒ–é…ç½®å®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… å®Œæˆçš„ç°ä»£åŒ–å‡çº§" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ”¨ å®Œå…¨é‡å»ºFlutteré¡¹ç›®ç»“æ„" >> $GITHUB_STEP_SUMMARY
        echo "- âš™ï¸ åº”ç”¨æœ€æ–°Flutter Gradleæ’ä»¶ç³»ç»Ÿ" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ“± å¯ç”¨AndroidXå’ŒJetifieræ”¯æŒ" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸš€ å‡çº§åˆ°Gradle 8.4" >> $GITHUB_STEP_SUMMARY
        echo "- âš¡ ä¼˜åŒ–æ„å»ºæ€§èƒ½å’Œå†…å­˜é…ç½®" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ”§ ä¿®å¤'unsupported Gradle project'é”™è¯¯" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“± æ„å»ºä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "- **æ„å»ºç±»å‹**: $BUILD_TYPE" >> $GITHUB_STEP_SUMMARY
        echo "- **åº”ç”¨åç§°**: èœè°±å¤§å…¨" >> $GITHUB_STEP_SUMMARY
        echo "- **åŒ…å**: com.example.recipe_app" >> $GITHUB_STEP_SUMMARY
        echo "- **æœ€ä½Androidç‰ˆæœ¬**: API 21" >> $GITHUB_STEP_SUMMARY
        echo "- **Flutterç‰ˆæœ¬**: 3.35.8" >> $GITHUB_STEP_SUMMARY
        echo "- **Gradleç‰ˆæœ¬**: 8.4" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ¯ è§£å†³çš„å…³é”®é—®é¢˜" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… 'unsupported Gradle project' é”™è¯¯å®Œå…¨ä¿®å¤" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… AndroidXä¾èµ–é—®é¢˜è§£å†³" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Gradleæ’ä»¶å¼ƒç”¨è­¦å‘Šæ¶ˆé™¤" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… æ„å»ºæ€§èƒ½ä¼˜åŒ–" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… å†…å­˜ä½¿ç”¨ä¼˜åŒ–" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“Š é¡¹ç›®çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
        BUILD_TIME=$(date '+%Y-%m-%d %H:%M:%S')
        echo "- **æ„å»ºæ—¶é—´**: $BUILD_TIME" >> $GITHUB_STEP_SUMMARY
        echo "- **GitHub Run**: #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        echo "- **åˆ†æ”¯**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **è§¦å‘æ–¹å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ’¡ ä½¿ç”¨æ–¹æ³•" >> $GITHUB_STEP_SUMMARY
        echo "1. ğŸ“¥ ä¸‹è½½é¡µé¢ä¸Šæ–¹çš„APKæ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        echo "2. ğŸ“± å®‰è£…åˆ°Androidè®¾å¤‡" >> $GITHUB_STEP_SUMMARY
        echo "3. ğŸ”§ å¦‚éœ€é‡æ–°æ„å»ºï¼Œæ‰‹åŠ¨è¿è¡Œæ­¤å·¥ä½œæµ" >> $GITHUB_STEP_SUMMARY
        echo "4. ğŸ› ï¸ é¡¹ç›®ç°åœ¨å¯ä»¥æœ¬åœ°ä½¿ç”¨ 'flutter run'" >> $GITHUB_STEP_SUMMARY

    - name: Final verification
      run: |
        echo "ğŸ” æœ€ç»ˆéªŒè¯..."
        
        # éªŒè¯å…³é”®æ–‡ä»¶å­˜åœ¨
        echo "æ£€æŸ¥å…³é”®é…ç½®æ–‡ä»¶:"
        ls -la android/settings.gradle
        ls -la android/app/build.gradle  
        ls -la android/gradle.properties
        
        echo ""
        echo "æ£€æŸ¥é¡¹ç›®ç»“æ„:"
        find . -name "*.dart" | head -5
        find . -name "*.jpg" -o -name "*.png" | head -3
        
        echo ""
        echo "âœ… éªŒè¯å®Œæˆï¼é¡¹ç›®å·²æˆåŠŸç°ä»£åŒ–é…ç½®å¹¶æ„å»ºã€‚"
