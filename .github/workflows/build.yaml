name: 构建APK

permissions:
  contents: write
  pull-requests: write
  actions: read
  packages: write

on:
  push:
    branches: [ main, master ]
    paths:
      - 'lib/**'
      - 'android/**'
      - 'pubspec.yaml'
      - '.github/workflows/build-apk.yml'
  
  pull_request:
    branches: [ main, master ]
    paths:
      - 'lib/**'
      - 'android/**'
      - 'pubspec.yaml'
  
  workflow_dispatch:
    inputs:
      build_type:
        description: '构建类型'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4

    - name: 缓存Flutter SDK
      uses: actions/cache@v3
      id: flutter-cache
      with:
        path: |
          /opt/hostedtoolcache/flutter
          /usr/local/bin/flutter
        key: flutter-cache-${{ runner.os }}-${{ hashFiles('**/.flutter-version') }}

    - name: 设置Flutter
      if: steps.flutter-cache.outputs.cache-hit != 'true'
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.22.0'
        channel: 'stable'
        cache: true

    - name: 设置Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'

    - name: 接受Android许可证（快速方案）
      uses: android-actions/setup-android@v3
      with:
        licenses: true

    - name: 检查Flutter环境
      run: |
        flutter --version
        flutter doctor -v

    - name: 缓存Android SDK
      uses: actions/cache@v3
      id: android-cache
      with:
        path: |
          ~/.android/build-cache
          $ANDROID_HOME/.downloadIntermediates
        key: android-cache-${{ runner.os }}-${{ hashFiles('**/android/**', '**/gradle/**') }}
        restore-keys: |
          android-cache-${{ runner.os }}-

    - name: 缓存Gradle
      uses: actions/cache@v3
      id: gradle-cache
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: gradle-${{ runner.os }}-${{ hashFiles('**/gradle/wrapper/gradle-wrapper.properties', '**/build.gradle') }}
        restore-keys: |
          gradle-${{ runner.os }}-

    - name: 缓存Pub依赖
      uses: actions/cache@v3
      id: pub-cache
      with:
        path: |
          ~/.pub-cache
          .dart_tool
        key: pub-${{ runner.os }}-${{ hashFiles('**/pubspec.lock') }}
        restore-keys: |
          pub-${{ runner.os }}-

    - name: 获取依赖
      run: flutter pub get

    - name: 分析代码
      run: flutter analyze

    - name: 构建APK
      id: build_apk
      run: |
        if [ "${{ github.event.inputs.build_type }}" = "release" ] || [ "${{ github.event_name }}" = "push" ]; then
          BUILD_TYPE="release"
          BUILD_ARGS="--release"
          echo "构建Release APK"
        else
          BUILD_TYPE="debug"
          BUILD_ARGS="--debug"
          echo "构建Debug APK"
        fi
        
        echo "开始构建 $BUILD_TYPE APK..."
        flutter build apk $BUILD_ARGS
        
        APK_PATH="build/app/outputs/flutter-apk/app-$BUILD_TYPE.apk"
        echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
        echo "build_type=$BUILD_TYPE" >> $GITHUB_OUTPUT

    - name: 上传APK构建产物
      uses: actions/upload-artifact@v4
      with:
        name: flclash-browser-${{ steps.build_apk.outputs.build_type }}-apk
        path: ${{ steps.build_apk.outputs.apk_path }}
        retention-days: 30
